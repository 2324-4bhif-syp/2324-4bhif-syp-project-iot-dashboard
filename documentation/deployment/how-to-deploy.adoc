= Deployment Leoenergy

== Prerequisites
* Machine with https://ubuntu.com/tutorials/install-ubuntu-desktop#1-overview[Ubuntu 24.04]
* https://docs.docker.com/engine/install/ubuntu/[Docker Engine with Docker Compose]
* https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04[Nginx]
* Files
** docker-compose.yaml
** grafana.ini

== Docker Compose

=== Services
* influxdb: our time-series database
** port mapped to 8086
* grafana: tool to create graphs from data in influxdb
** port mapped to 3000
* leoenergy: receives mqtt messages and writes data to influxdb
** port mapped to 8080
* frontend: display data, with embedded grafana boards
** port mapped to 8000

.docker-compose.yaml
[source, yaml]
----
include::files/docker-compose.yaml[]
----
<1> You can define username and password using environment-variables
<2> Bind mounting of influxdb data
<3> It's important to mount the data correctly using bind mounts. You also need grafana.ini file in the same directory as your docker-compose.yaml

=== Grafana Initialization File (grafana.ini)
IMPORTANT: You need grafana.ini file in the same directory as your docker-compose.yaml.

change follwing attributes to the options you need:

.grafana.ini
[source, ini]
----
http_port = 3000
domain = <server_domain_without_protocol>
enforce_domain = false
root_url = https://<server_domain>/grafana/
root_url = %(protocol)s://%(domain)s:%(http_port)s/grafana/
serve_from_sub_path = false
admin_user = <choose_admin_username>
admin_password = <choose_admin_password>
allow_embedding = true
enabled = true
----

=== Start all the Services using:

[source, bash]
----
docker compose up -d
----

== Nginx as Reverse Proxy

=== Secure connections with HTTPS

==== https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04[Install Nginx]

==== Install Certbot

[source, bash]
----
sudo apt update
sudo apt install certbot python3-certbot-nginx
----

==== Generate certificates

[source, bash]
----
sudo certbot --nginx -d your_domain
----

TIP: Certbot *automatically* creates all links to all certificates in the configuration file.

=== Nginx-Configuration

In the same `server`-block where the certificates and HTTPS ports are defined, define following routes:

./etc/nginx/sites-available/default
[source]
----
location / {
        proxy_set_header Accept-Encoding "";
        proxy_pass http://localhost:8000;
}

location /grafana/ {
        proxy_pass http://localhost:3000/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (Grafana uses WebSockets for real-time updates)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
}
----

Test nginx configuration:

[source, bash]
----
sudo nginx -t
----

Restart nginx:

[source, bash]
----
sudo systemctl restart nginx
----

== Leoenergy is deployed :-)

image::files/deployment.png[]